name: regime_donchian_v3
objective: |
  Determine whether regime detection improves Donchian breakout performance on
  BTC daily data. The unfiltered Donchian baseline achieves Sharpe ~1.06
  (walk-forward, 30 bps costs, sqrt(365) annualization).

  Success = a regime-aware variant that achieves Sharpe >= 1.0 with DSR > 0.95
  (statistically significant after multiple testing correction).
  A well-documented negative result is equally valid.

  Existing code to leverage:
  - sparky.models.regime_filtered_donchian (vol filter)
  - sparky.models.regime_hmm (HMM states)
  - sparky.models.regime_weighted_ensemble (dynamic weighting)
  - sparky.features.regime_indicators (vol regime, trend detection)
  - sparky.models.simple_baselines.donchian_channel_strategy (baseline)

  Research guidance (not prescriptive — use your judgment):
  - Priority 1: Sizing > filtering. Academic evidence suggests regime-dependent
    position sizing (smaller in high-vol, larger in low-vol) beats binary
    on/off filtering. Try fractional sizing proportional to inverse vol first.
  - Priority 2: HMM with 2-3 states. 4+ states overfits on daily data.
    Add features one at a time and measure regime stability (state assignment
    persistence). Rolling 1yr vs 2yr training windows for the HMM itself.
  - Priority 3: Soft probability sizing. Instead of hard regime labels,
    use HMM posterior probabilities as continuous sizing weights.
  - Priority 4: Regime transition detection. The most profitable moments
    may be regime transitions, not steady states. Detect transitions and
    use them as a separate sizing/entry signal.
  - Run winners at BOTH 30 bps (standard) and 50 bps (stress test).
    A strategy that only works at 30 bps but not 50 bps is fragile.
constraints:
  asset: btc
  timeframe: daily
  dataset: btc_daily
  gpu_required: false
  transaction_costs_bps: 30
  annualization: 365
  n_trials_cumulative: true
strategy_space:
  - family: regime_sized_donchian
    description: "Regime-dependent position sizing (inverse vol, fractional) instead of binary filtering"
    priority: 1
    parameter_ranges:
      entry_period: [15, 20, 30, 40, 60]
      exit_period: [5, 10, 15, 20, 30]
      vol_window: [20, 30, 45, 60]
      sizing_method: [inverse_vol, fractional_regime, kelly_regime]
  - family: hmm_regime_donchian
    description: "HMM-detected regimes (2-3 states) with per-state Donchian parameters or sizing"
    priority: 2
    parameter_ranges:
      n_states: [2, 3]
      hmm_features: [returns_only, returns_vol, returns_vol_volume]
      hmm_training_window: [252, 504]
      entry_period: [15, 20, 30, 40]
      exit_period: [5, 10, 15, 20]
  - family: soft_probability_sizing
    description: "HMM posterior probabilities as continuous position sizing weights"
    priority: 3
    parameter_ranges:
      n_states: [2, 3]
      sizing_blend: [linear, sigmoid, threshold_soft]
      entry_period: [20, 30, 40]
      exit_period: [10, 15, 20]
  - family: transition_detection
    description: "Regime transition detection as a separate entry/sizing signal"
    priority: 4
    parameter_ranges:
      transition_method: [hmm_probability_delta, vol_crossover, trend_reversal]
      lookback: [5, 10, 20]
      entry_period: [20, 30, 40]
      exit_period: [10, 15, 20]
stopping_criteria:
  success:
    min_sharpe: 1.0
    min_dsr: 0.95
  budget:
    max_sessions: 3
    max_hours: 2
    max_cost_usd: 20
    digest_every: 3
  stall:
    sessions_without_improvement: 3
    improvement_threshold: 0.05
    diversity_threshold: 0.80
session_limits:
  max_session_minutes: 30
  max_cost_per_session: 8.0
  min_session_minutes: 5
  max_consecutive_crashes: 3
wandb_tags: [regime_donchian_v3]
gates:
  - trigger: success_criteria_met
    action: pause_and_alert
  - trigger: stall_detected
    action: pause_and_alert
exclusions:
  - "Do not evaluate on OOS data (boundary defined in configs/holdout_policy.yaml)"
  - "Do not build paper trading infrastructure"
  - "Do not use git (no branches, commits, or pushes)"
  - "Always use sparky.data.loader.load() for data — never pd.read_parquet()"
  - "Always use compute_all_metrics(returns, n_trials=N) and report DSR"
  - "n_trials must be cumulative across the entire directive, not per session"
  - "Always include transaction costs (standard 30 bps, stress test 50 bps) — report both for winners"
  - "Compare every result against the unfiltered Donchian baseline"
  - "Report ALL configs to wandb — no cherry-picking. Negative results are valuable."
